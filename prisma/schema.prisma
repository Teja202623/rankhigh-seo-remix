// Prisma Schema for RankHigh SEO
// Merged: Shopify Remix template Session + RankHigh SEO business models

generator client {
  provider = "prisma-client-js"
}

// PostgreSQL for both local and production
// Railway will automatically provide DATABASE_URL via ${{Postgres.DATABASE_URL}}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================
// SHOPIFY SESSION STORAGE
// Required by @shopify/shopify-app-session-storage-prisma
// Using enhanced Session model from Shopify Remix template
// ====================

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt

  @@index([shop])
}

// ====================
// CORE APP MODELS
// ====================

model Store {
  id                  String   @id @default(uuid())
  shopUrl             String   @unique
  accessToken         String
  plan                String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  isActive            Boolean  @default(true)
  onboardingCompleted Boolean  @default(false)
  onboardingStep      Int      @default(1) // Current step in onboarding (1-5)
  gtmId               String?  // Google Tag Manager ID
  ga4Id               String?  // Google Analytics 4 ID
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Sitemap Settings
  sitemapExcludePasswordProtected Boolean   @default(false)
  sitemapExcludeOutOfStock        Boolean   @default(false)
  sitemapExcludeDraft             Boolean   @default(true)
  sitemapExcludeSearch            Boolean   @default(true)
  sitemapExcludeCart              Boolean   @default(true)
  sitemapExcludeCheckout          Boolean   @default(true)
  sitemapExcludeAccount           Boolean   @default(true)
  sitemapCustomExclusions         String?   // JSON array of regex patterns
  sitemapLastGenerated            DateTime?
  sitemapUrlCount                 Int       @default(0)
  sitemapXmlContent               String?   // Cached XML content

  // Google Search Console Integration
  gscAccessToken      String?   // OAuth access token
  gscRefreshToken     String?   // OAuth refresh token for automatic renewal
  gscTokenExpiry      DateTime? // Token expiration timestamp
  gscConnected        Boolean   @default(false) // Connection status
  gscPropertyUrl      String?   // Selected GSC property URL
  gscLastSync         DateTime? // Last successful data sync

  // Relations
  audits        Audit[]
  pages         Page[]
  keywords      Keyword[]
  users         User[]
  schemas       SchemaMarkup[]
  redirects     Redirect[]
  notifications Notification[]
  gscQueries    GSCQuery[]
  gscPages      GSCPage[]
  gscMetrics    GSCMetric[]
  activityLogs  ActivityLog[]

  @@index([shopUrl])
  @@index([isActive])
  @@index([onboardingCompleted])
}

model User {
  id        String   @id @default(uuid())
  storeId   String
  email     String
  name      String?
  role      String   @default("ADMIN") // ADMIN, EDITOR, VIEWER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, email])
  @@index([storeId])
}

// ====================
// SEO AUDIT MODELS
// ====================

model Audit {
  id             String    @id @default(uuid())
  storeId        String
  status         String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  totalUrls      Int       @default(0)
  completed      Int       @default(0)
  criticalIssues Int       @default(0)
  highIssues     Int       @default(0)
  mediumIssues   Int       @default(0)
  lowIssues      Int       @default(0)
  overallScore   Int? // 0-100 SEO score
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
  @@index([storeId, status])
}

// ====================
// PAGE MODELS
// ====================

model Page {
  id              String   @id @default(uuid())
  storeId         String
  url             String
  title           String?
  metaTitle       String?
  metaDescription String?
  h1              String?
  wordCount       Int?
  status          String   @default("ACTIVE") // ACTIVE, DRAFT, ARCHIVED
  pageType        String? // PRODUCT, COLLECTION, BLOG, ARTICLE, PAGE
  shopifyId       String? // Reference to Shopify resource
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  store     Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  seoIssues SEOIssue[]

  @@index([storeId])
  @@index([storeId, pageType])
  @@index([storeId, status])
  @@index([shopifyId])
  @@unique([storeId, url])
}

model SEOIssue {
  id         String   @id @default(uuid())
  pageId     String
  type       String // MISSING_META_TITLE, DUPLICATE_CONTENT, BROKEN_LINK, etc.
  severity   String // CRITICAL, HIGH, MEDIUM, LOW
  message    String
  suggestion String? // How to fix
  isFixed    Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId, severity])
  @@index([pageId, isFixed])
  @@index([severity, isFixed, createdAt])
}

// ====================
// KEYWORD TRACKING
// ====================

model Keyword {
  id           String   @id @default(uuid())
  storeId      String
  keyword      String
  targetUrl    String?
  searchVolume Int?
  difficulty   Int? // 0-100
  isTracking   Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  store    Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  rankings KeywordRanking[]

  @@index([storeId])
  @@index([storeId, isTracking])
}

model KeywordRanking {
  id        String   @id @default(uuid())
  keywordId String
  position  Int
  url       String?
  device    String   @default("DESKTOP") // DESKTOP, MOBILE
  location  String   @default("US")
  date      DateTime @default(now())

  keyword Keyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId, date])
}

// ====================
// SCHEMA MARKUP
// ====================

model SchemaMarkup {
  id        String   @id @default(uuid())
  storeId   String
  pageId    String? // Optional - can be store-wide
  type      String // PRODUCT, ARTICLE, FAQ, BREADCRUMB, ORGANIZATION, etc.
  schema    Json // JSON-LD schema
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, type])
  @@index([storeId, isActive])
}

// ====================
// REDIRECTS
// ====================

model Redirect {
  id        String   @id @default(uuid())
  storeId   String
  from      String
  to        String
  type      String   @default("301") // 301, 302, 307
  hits      Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, isActive])
  @@unique([storeId, from])
}

// ====================
// NOTIFICATIONS
// ====================

model Notification {
  id        String   @id @default(uuid())
  storeId   String
  type      String // INFO, WARNING, ERROR, SUCCESS
  title     String
  message   String
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, isRead, createdAt])
}

// ====================
// GOOGLE SEARCH CONSOLE INTEGRATION (Tasks 49-56)
// ====================

model GSCQuery {
  id          String   @id @default(uuid())
  storeId     String
  query       String   // Search query text
  clicks      Int      // Number of clicks
  impressions Int      // Number of impressions
  ctr         Float    // Click-through rate (0-1)
  position    Float    // Average position in search results
  date        DateTime // Date of the data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, date])
}

model GSCPage {
  id          String   @id @default(uuid())
  storeId     String
  pageUrl     String   // Page URL
  clicks      Int      // Number of clicks
  impressions Int      // Number of impressions
  ctr         Float    // Click-through rate (0-1)
  position    Float    // Average position in search results
  date        DateTime // Date of the data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, date])
}

model GSCMetric {
  id                String   @id @default(uuid())
  storeId           String
  totalClicks       Int      // Total clicks in period
  totalImpressions  Int      // Total impressions in period
  averageCtr        Float    // Average CTR in period
  averagePosition   Float    // Average position in period
  startDate         DateTime // Period start date
  endDate           DateTime // Period end date
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, startDate])
}

// ====================
// ACTIVITY LOG (Task 62)
// ====================

model ActivityLog {
  id          String   @id @default(uuid())
  storeId     String
  action      String   // "META_UPDATED", "ALT_ADDED", "SITEMAP_GENERATED", etc.
  description String   // Human-readable description
  metadata    Json?    // Additional data (productId, count, etc.)
  createdAt   DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
}
